import pygame
import random
from hero import Hero
from assets import (ALTO_VENTANA, ANCHO_VENTANA)
from auxi import SurfaceManager as sf

class Enemy(pygame.sprite.Sprite):
    def __init__(self,frame_rate, speed_walk):
        super().__init__()
        self.__walk_r = sf.get_surface_from_spritesheet('Facul\Parcial pygame\Renders\enemy_walk.png', 6, 1)
        self.__walk_l = sf.get_surface_from_spritesheet('Facul\Parcial pygame\Renders\enemy_walk.png', 6, 1, flip=True)
        self.__move_x = 0
        self.__move_y = 0
        self.__speed_walk = speed_walk
        self.__frame_rate = frame_rate
        self.__actual_animation = self.__walk_r
        self.__enemy_move_time = 0
        self.__enemy_animation_time = 0
        self.__initial_frame = 0
        self.__actual_img_animation = self.__actual_animation[self.__initial_frame]
        self.__rect = self.__actual_img_animation.get_rect()
        self.__is_looking_right = True
        self.__rect.x = random.randint(0,1080)
        self.__rect.y = random.randint(0,200)
        self.sprite_group = pygame.sprite.Group()

    def __set_x_animations_preset(self, move_x, animation_list: list[pygame.surface.Surface], look_r: bool):
        self.__move_x = move_x
        self.__actual_animation = animation_list
        self.__is_looking_right = look_r
    
    def __set_y_animations_preset(self, move_y, animation_list: list[pygame.surface.Surface], look_r: bool):
        self.__move_y = move_y
        self.__actual_animation = animation_list

    def walk(self):
        ubicacion_heroe_x = Hero.get_x
        ubicacion_heroe_y = Hero.get_y
        if self.__rect.x < ubicacion_heroe_x:
            look_right = True
            self.__set_x_animations_preset(self.__speed_walk, self.__walk_r, look_r=look_right)
        else:
            look_right = False
            self.__set_x_animations_preset(-self.__speed_walk, self.__walk_l, look_r=look_right)
        if self.__rect.y < ubicacion_heroe_y:
            look_right = self.__is_looking_right
            if look_right == True:
                self.__set_y_animations_preset(self.__speed_walk, self.__walk_r)
            else:
                self.__set_y_animations_preset(self.__speed_walk, self.__walk_l)
        elif 'Down':
            look_right = self.__is_looking_right
            if look_right == True:
                self.__set_y_animations_preset(self.__speed_walk, self.__walk_r)
            else:
                self.__set_y_animations_preset(self.__speed_walk, self.__walk_l)

    def draw(self, screen: pygame.surface.Surface):
        # if DEBUG:
        #     pygame.draw.rect(screen, 'red', self.__rect)
        #     pygame.draw.rect(screen, 'green', self.__rect.bottom)
        self.__actual_img_animation = self.__actual_animation[self.__initial_frame]
        screen.blit(self.__actual_img_animation, self.__rect)

    def __set_borders_limits_x(self):
        pixels_move = 0
        if self.__move_x > 0:
            pixels_move = self.__move_x if self.__rect.x < ANCHO_VENTANA - self.__actual_img_animation.get_width() else 0
        elif self.__move_x < 0:
            pixels_move = self.__move_x if self.__rect.x > 0 else 0
        return pixels_move
    def __set_borders_limits_y(self):
        pixels_move = 0
        if self.__move_y > 0:
            pixels_move = self.__move_y if self.__rect.y < ALTO_VENTANA - self.__actual_img_animation.get_height() else 0
        elif self.__move_y < 0:
            pixels_move = self.__move_y if self.__rect.y > 0 else 0
        return pixels_move
    

    def do_movement(self, delta_ms):
        self.__enemy_move_time += delta_ms
        if self.__enemy_move_time >= self.__frame_rate:
            self.__enemy_move_time = 0
            self.__rect.x += self.__set_borders_limits_x()
            self.__rect.y += self.__set_borders_limits_y()
    

    def do_animation(self, delta_ms):
        self.__enemy_animation_time += delta_ms
        if self.__enemy_animation_time >= self.__frame_rate:
            self.__enemy_animation_time = 0
            if self.__initial_frame < len(self.__actual_animation) - 1:
                self.__initial_frame += 1
            else:
                self.__initial_frame = 0
    
    def update(self, delta_ms):
        self.do_movement(delta_ms)
        self.do_animation(delta_ms)
        self.sprite_group.update()

    def draw(self, screen: pygame.surface.Surface):
        self.__actual_img_animation = self.__actual_animation[self.__initial_frame]
        screen.blit(self.__actual_img_animation, self.__rect)
